#!/bin/bash
. ./lib

if lspci | grep -E "(VGA|3D)" |  awk '/AMD/';then
  gpumodule1="amdgpu radeon"
else
  gpumodule1=""
fi

if lspci | grep -E "(VGA|3D)" |  awk '/NVIDIA/';then
  gpumodule2="nvidia nvidia_modeset nvidia_uvm nvidia_drm"
else
  gpumodule2=""
fi
gpumodule="$gpumodule1 $gpumodule2"

# NVIDIA modules in mkinitcpio
sudo sed -i "s/MODULES=()/MODULES=($gpumodule)/g" /etc/mkinitcpio.conf
sudo mkinitcpio -P
# Additional steps
printf "options nvidia-drm modeset=1" | sudo tee /etc/modprobe.d/nvidia.conf
# Blacklist nouveau
printf "blacklist nouveau" | sudo tee /etc/modprobe.d/nouveau.conf
